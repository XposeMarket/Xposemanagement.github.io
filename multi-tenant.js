(function(){if(!window.readLS||!window.writeLS)return;const LS_KEYS={users:"xm_users",session:"xm_session",data:"xm_data",shops:"xm_shops"};function getUsers(){return readLS(LS_KEYS.users,[])||[]}function setUsers(v){writeLS(LS_KEYS.users,v||[])}function getSession(){return readLS(LS_KEYS.session,null)}function getData(){return readLS(LS_KEYS.data,{settings:{},appointments:[],jobs:[],threads:[],invoices:[]})}function setData(v){writeLS(LS_KEYS.data,v||{})}function getShops(){return readLS(LS_KEYS.shops,[])||[]}function setShops(v){writeLS(LS_KEYS.shops,v||[])}function uid(p){return(p||"id")+Math.random().toString(36).slice(2,8)}function currentUser(){const s=getSession();if(!s||!s.email)return null;return getUsers().find(u=>u.email===s.email)||null}function currentShop(){const u=currentUser();if(!u||!u.shop_id)return getShops()[0]||null;return getShops().find(s=>s.id===u.shop_id)||null}(function(){const shops=getShops();if(shops.length)return;const sid="s1";setShops([{id:sid,name:"Demo Shop",type:"Mechanic",join_code:"ABCD12",staff_limit:3}]);const users=getUsers();if(users.length){users[0].role=users[0].role||"admin";users[0].shop_id=users[0].shop_id||sid;setUsers(users)}const d=getData();["appointments","jobs","threads","invoices"].forEach(k=>{d[k]=(d[k]||[]).map(x=>({shop_id:sid,...x}))});setData(d)})();document.addEventListener("DOMContentLoaded",function(){const page=(location.pathname.split("/").pop()||"index.html").toLowerCase();if(page==="settings.html")enhanceSettings();if(page==="create-shop.html")initCreateShop();if(page==="signup.html")enhanceSignup();if(page==="index.html")enhanceLogin()});function enhanceLogin(){document.getElementById("btnCreateAccount")?.addEventListener("click",e=>{e.preventDefault();location.assign("signup.html")});document.getElementById("btnCreateShop")?.addEventListener("click",e=>{e.preventDefault();location.assign("create-shop.html")})}function enhanceSettings(){const u=currentUser();const shop=currentShop();const main=document.querySelector("main.container")||document.querySelector("main");if(!u||!main||!shop)return;const canAdmin=u.role==="admin";const card=document.createElement("div");card.className="card";card.style.marginTop="16px";card.innerHTML=`<h2>Shop Access & Team</h2><div class="grid cols-3"><div><label>Shop Type</label><select id="setShopType" ${canAdmin?"":"disabled"}><option ${shop?.type==="Mechanic"?"selected":""}>Mechanic</option><option ${shop?.type==="Body"?"selected":""}>Body</option><option ${shop?.type==="Other"?"selected":""}>Other</option></select></div><div><label>Staff Limit</label><input id="setStaffLimit" type="number" min="1" value="${shop?.staff_limit||3}" ${canAdmin?"":"disabled"}></div><div><label>Join Code</label><div class="row" style="gap:8px;"><input id="setJoinCode" value="${shop?.join_code||""}" readonly></div></div></div><div style="margin-top:16px"><h3>Staff List</h3><table class="table" id="staffTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table><p class="notice">Slots used: <span id="slotsUsed">0</span> / <span id="slotsMax">${shop?.staff_limit||3}</span></p></div>`;main.appendChild(card);const all=getUsers().filter(x=>x.shop_id===(shop&&shop.id));const tbody=card.querySelector("#staffTable tbody");let used=0;all.forEach(us=>{if(us.role!=="admin")used++;const tr=document.createElement("tr");const roleCtl=canAdmin?`<select class="roleSel" data-uid="${us.id}"><option value="admin"${us.role==="admin"?" selected":""}>admin</option><option value="service_writer"${us.role==="service_writer"?" selected":""}>service_writer</option><option value="receptionist"${us.role==="receptionist"?" selected":""}>receptionist</option><option value="staff"${us.role==="staff"?" selected":""}>staff</option></select>`:us.role;const actions=canAdmin&&us.id!==u.id?`<button class="btn danger" data-remove="${us.id}">Remove</button>`:"";tr.innerHTML=`<td>${us.first} ${us.last}</td><td>${us.email}</td><td>${roleCtl}</td><td>${actions}</td>`;tbody.appendChild(tr)});card.querySelector("#slotsUsed").textContent=String(used);if(canAdmin){tbody.querySelectorAll(".roleSel").forEach(sel=>{sel.addEventListener("change",()=>{const uid=sel.getAttribute("data-uid");const users=getUsers();const i=users.findIndex(x=>x.id===uid);if(i>=0){users[i].role=sel.value;setUsers(users);}})});tbody.querySelectorAll("[data-remove]").forEach(btn=>{btn.addEventListener("click",()=>{const uid=btn.getAttribute("data-remove");if(!confirm("Remove this user from your shop? Their active jobs will be unassigned."))return;const users=getUsers();const i=users.findIndex(x=>x.id===uid);if(i<0)return;const d=getData();(d.jobs||[]).forEach(j=>{if(j.assigned_to===uid)j.assigned_to=null});setData(d);users[i].shop_id=null;setUsers(users);location.reload();})});card.querySelector("#setStaffLimit").addEventListener("change",(e)=>{const shops=getShops();const si=shops.findIndex(s=>s.id===shop.id);if(si>=0){shops[si].staff_limit=Math.max(1,parseInt(e.target.value||"3",10));setShops(shops);card.querySelector("#slotsMax").textContent=String(shops[si].staff_limit)}});card.querySelector("#setShopType").addEventListener("change",(e)=>{const shops=getShops();const si=shops.findIndex(s=>s.id===shop.id);if(si>=0){shops[si].type=e.target.value;setShops(shops)}})}}function enhanceSignup(){const form=document.getElementById("signupForm");if(!form)return;const joinLabel=document.createElement("label");joinLabel.textContent="Shop Join Code";const join=document.createElement("input");join.id="suJoin";join.placeholder="Enter join code";join.required=true;const err=document.getElementById("signupErr");form.insertBefore(join,form.firstChild);form.insertBefore(joinLabel,join);form.addEventListener("submit",function(e){const first=(document.getElementById("suFirst")||{}).value||"";const last=(document.getElementById("suLast")||{}).value||"";const email=(document.getElementById("suEmail")||{}).value||"";const pass=(document.getElementById("suPass")||{}).value||"";const code=join.value.trim().toUpperCase();const shops=getShops();const shop=shops.find(s=>String(s.join_code||"").toUpperCase()===code);if(!shop){e.preventDefault();if(err)err.textContent="Invalid join code.";return;}const users=getUsers();if(users.some(u=>u.email===email)){e.preventDefault();if(err)err.textContent="Email already in use.";return;}users.push({id:uid("u_"),first,last,email,password:pass,role:"staff",shop_id:shop.id});setUsers(users);writeLS(LS_KEYS.session,{email,at:Date.now()});setTimeout(()=>{location.href="dashboard.html"},10)},{once:false})}function initCreateShop(){const form=document.getElementById("createShopForm");const err=document.getElementById("csErr");if(!form)return;form.addEventListener("submit",function(e){e.preventDefault();const shopName=document.getElementById("csName").value.trim();const shopType=document.getElementById("csType").value.trim();const shopLogo=document.getElementById("csLogo").value.trim();const first=document.getElementById("csFirst").value.trim();const last=document.getElementById("csLast").value.trim();const email=document.getElementById("csEmail").value.trim();const pass=document.getElementById("csPass").value.trim();if(!shopName||!shopType||!first||!last||!email||!pass){if(err)err.textContent="Please fill all required fields.";return;}const shops=getShops();const shopId=uid("shop_");const join_code=Math.random().toString(36).slice(2,8).toUpperCase();const shop={id:shopId,name:shopName,type:shopType,logo:shopLogo||"",join_code,staff_limit:3};shops.push(shop);setShops(shops);const users=getUsers();if(users.some(u=>u.email===email)){if(err)err.textContent="Email already in use.";return;}const admin={id:uid("u_"),first,last,email,password:pass,role:"admin",shop_id:shopId};users.push(admin);setUsers(users);const data=getData();data.settings=data.settings||{};data.settings.shop={...(data.settings.shop||{}),name:shopName,logo:shopLogo||"",type:shopType,shop_id:shopId};setData(data);writeLS(LS_KEYS.session,{email:admin.email,at:Date.now()});location.href="settings.html"})} })();
