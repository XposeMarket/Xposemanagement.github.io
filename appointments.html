<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Appointments</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* tiny, surgical additions */
    .pill-save {
      display:inline-flex; align-items:center; gap:6px;
      background:#1677ff; color:#fff; border:none;
      padding:4px 10px; border-radius:999px; cursor:pointer;
      font-size:.85em; line-height:1; white-space:nowrap;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
.pill-save.saved { background:#6b7280; color:#fff; opacity:.95; }
    .pill-save:disabled { opacity:.6; cursor:not-allowed; }
    .pill-save .dot { width:6px; height:6px; border-radius:50%; background:#fff; opacity:.9; }

    /* Split toolbars: left action group + right Save Customer */
    .splitbar { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .splitbar .left { display:flex; align-items:center; gap:8px; }
    .splitbar .right { display:flex; align-items:center; gap:8px; }

    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:70; }
    .modal-card { width:min(640px,92vw); background:var(--card,#fff); color:inherit; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border,#e5e5e5); }
    .modal-body { padding:12px 14px; }
    .modal-foot { display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--border,#e5e5e5); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: inherit; }
    .notification { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .hidden { display:none; }
  </style>
</head>
<body>
<header class="top">
  <div class="container row top row">
    <a class="brand" href="dashboard.html" aria-label="Home">
      <img id="headerLogo" src="XposeManagementCRMlogo.png" alt="Logo">
    </a>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button><nav id="mainNav">
      <a href="dashboard.html" class="">Dashboard</a>
      <a href="appointments.html" class="active">Appointments</a>
      <a href="jobs.html" class="">Jobs</a>
      <a href="messages.html" class="">Messages</a>
      <a href="invoices.html" class="">Invoices</a>
      <a href="customers.html" class="">Customers</a>
      <a href="settings.html" class="">Settings</a>
      <a href="profile.html" class="">Profile</a>
    </nav>
    <div id="notification" class="notification hidden"></div>
    <div>
      <button id="themeToggle" class="btn" aria-label="Toggle theme">Theme</button>
      <button id="logoutBtn" class="btn" aria-label="Logout">Logout</button>
    </div>
  </div>
</header>

<main class="container" style="padding:16px 0">
  <h1>Appointments</h1>
  <div class="card">
    <div class="toolbar">
  <button id="newAppt" class="btn info">New Appointment</button>
      <input id="apptSearch" placeholder="Search‚Ä¶">
      <select id="apptStatus">
        <option value="">All Statuses</option>
        <option>new</option><option>scheduled</option><option>in_progress</option>
        <option>awaiting_parts</option><option>completed</option>
      </select>
      <button id="apptFilter" class="btn">Apply</button>
    </div>

    <table class="table" id="apptTable">
      <thead>
        <tr>
          <th data-col="created" class="sortable">Created</th>
          <th data-col="customer" class="sortable">Customer</th>
          <th data-col="vehicle" class="sortable">Vehicle</th>
          <th data-col="service" class="sortable">Service</th>
          <th data-col="scheduled" class="sortable">Scheduled</th>
          <th data-col="time" class="sortable">Time</th>
          <th data-col="status" class="sortable">Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="notice" id="apptEmpty"></p>
  </div>
</main>

<!-- ===== Quick New modal (kept) ===== -->
<div id="newApptModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3>New Appointment</h3>
      <button id="closeAppt" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <div class="grid cols-2">
        <div><label>First name</label><input id="naFirst"></div>
        <div><label>Last name</label><input id="naLast"></div>
      </div>

      <label>Email (optional)</label><input id="naEmail" type="email">
      <label>Phone</label><input id="naPhone">

      <label>Vehicle (Year Make Model)</label><input id="naVehicle">
      <div class="grid cols-2">
        <div style="margin-top:8px">
          <label>VIN (optional)</label>
          <input id="naVin" maxlength="17" placeholder="17 characters">
        </div>
        <div>
          <label>Service</label>
          <input id="naService" list="svcOptions" autocomplete="off">
          <datalist id="svcOptions"></datalist>
        </div>
        <div><label>Date</label><input id="naDate" type="date"></div>
      </div>

      <label>Time</label><input id="naTime" type="time">
    </div>
    <div class="modal-foot">
      <div class="splitbar" style="width:100%; margin:0; padding:0; border:0">
        <div class="left">
          <button id="saveAppt" class="btn info">Save</button>
        </div>
        <div class="right">
          <button id="saveCustNew" class="pill-save" title="Save customer for reuse">
            <span class="dot"></span> Save Customer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="container">¬© Xpose Market</footer>

<!-- Edit Appointment Modal -->
<div id="apptModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="apptModalTitle">Edit Appointment</h3>
      <button id="closeApptModal" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <form id="apptForm">
        <div class="grid cols-2">
          <div><label>Customer</label><input name="customer" required></div>
          <div><label>Phone</label><input name="phone" required></div>
        </div>
        <div class="grid cols-2">
          <div><label>Email</label><input name="email" type="email" placeholder="email@example.com"></div>
          <div><label>Vehicle</label><input name="vehicle" required></div>
        </div>
        <div class="grid cols-2">
          <div><label>VIN</label><input name="vin" id="apptVin"></div>
          <div><label>Service</label><input name="service" list="svcOptions" autocomplete="off"></div>
        </div>
        <div class="grid cols-2">
          <div><label>Date</label><input name="preferred_date" type="date" required></div>
          <div><label>Time</label><input name="preferred_time" type="time"></div>
        </div>
        <label>Notes</label>
        <textarea name="notes" rows="3"></textarea>
      </form>
    </div>
    <div class="modal-foot">
      <div class="splitbar" style="width:100%; margin:0; padding:0; border:0">
        <div class="left">
          <button id="saveApptEdit" type="submit" class="btn info">Save</button>
        </div>
        <div class="right">
          <button id="saveCustEdit" class="pill-save" title="Save customer for reuse">
            <span class="dot"></span> Save Customer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Service (Appointments) -->
<div id="editSvcModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3>Edit Service</h3>
      <button id="closeEditSvc" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <label>Service</label>
      <input id="esService" placeholder="Service name">
      <div class="grid cols-3">
        <div>
          <label>Parts $</label>
          <input id="esParts" type="number" step="0.01">
        </div>
        <div>
          <label>Labor $/hr</label>
          <div class="row" style="display:flex;gap:8px">
            <input id="esLabor" type="number" step="0.01">
            <button id="esPickRate" class="btn">Choose rate</button>
          </div>
        </div>
        <div>
          <label>Hours</label>
          <input id="esHours" type="number" step="0.25">
        </div>
      </div>
      <p id="esNotice" class="notice"></p>
    </div>
    <div class="modal-foot">
      <button id="saveEditSvc" class="btn info">Save</button>
    </div>
  </div>
</div>

<script src="vendor/supabase.umd.js"></script>
<script type="module" src="app.js"></script>
<script src="multi-tenant.js"></script>

<!-- ===== Appointment Modal (Create/Edit unified) ===== -->
<div id="apptModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="apptModalTitle">Edit Appointment</h3>
      <button type="button" class="btn" id="closeApptModal">Close</button>
    </div>
    <div class="modal-body">
      <form id="apptForm">
        <div class="grid cols-2">
          <div>
            <label>Customer</label>
            <input name="customer" placeholder="Name">
          </div>
          <div>
            <label>Phone</label>
            <input name="phone" placeholder="(555) 555-5555">
          </div>
          <div>
            <label>Email</label>
            <input name="email" type="email" placeholder="email@example.com">
          </div>
          <div>
            <label>Vehicle</label>
            <input name="vehicle" placeholder="Year Make Model">
          </div>
          <div>
            <label>VIN (optional)</label>
            <input id="apptVin" name="vin" maxlength="17" placeholder="17 characters">
          </div>
          <div>
            <label>Service</label>
            <input name="service" list="svcOptions" placeholder="Oil Change" autocomplete="off">
          </div>
          <div>
            <label>Date</label>
            <input type="date" name="preferred_date">
          </div>
          <div>
            <label>Time</label>
            <input type="time" name="preferred_time">
          </div>
        </div>

        <label>Notes</label>
        <textarea name="notes" rows="3" placeholder="Anything else?"></textarea>
      </form>
    </div>
    <div class="modal-foot">
      <div class="splitbar" style="width:100%; margin:0; padding:0; border:0">
        <div class="left">
          <button type="submit" form="apptForm" class="btn info">Save</button>
        </div>
        <div class="right">
          <button id="saveCustEdit" type="button" class="pill-save" title="Save customer for reuse">
            <span class="dot"></span> Save Customer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Save Customer wiring (Phase 2A - Supabase integration) ===== -->
<script type="module">
import { upsertCustomerToSupabase } from './pages/appointments.js';

(function(){
  const LS = window.LS || {users:"xm_users",session:"xm_session",data:"xm_data"};
  const $ = (s,root)=> (root||document).querySelector(s);
  const $$ = (s,root)=> Array.from((root||document).querySelectorAll(s));
  function readLS(k,f){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):(f??null);}catch(e){ return f??null; } }
  function writeLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  function currentUser(){ const sess=readLS(LS.session, {})||{}; const users=readLS(LS.users, [])||[]; return users.find(u=>u.id===sess.user_id||u.email===sess.email)||sess.user||{}; }
  function myRole(){ return (currentUser().role||'').toLowerCase(); }
  function currentShopId(){ return currentUser().shop_id || (readLS('xm_shops', [])[0]?.id) || 'shop_demo'; }
  const isStaff = ()=> myRole()==='staff';

  function normPhone(s){ return (s||'').replace(/\D+/g,''); }
  function normEmail(s){ return (s||'').trim().toLowerCase(); }

  // Parse helpers
  function parseFullName(name){
    name=(name||'').trim(); if(!name) return {first:'',last:''};
    const parts=name.split(/\s+/); const first=parts.shift()||''; return {first,last:parts.join(' ')||''};
  }
  function parseYMM(str){
    const s=(str||'').trim(); if(!s) return {year:'',make:'',model:''};
    const parts=s.split(/\s+/);
    const year = /^\d{4}$/.test(parts[0]) ? parts.shift() : '';
    const make = parts.shift()||'';
    const model = parts.join(' ')||'';
    return {year,make,model};
  }

  // üÜï Save customer to Supabase (delegates to appointments.js function)
  async function saveCustomerToSupabase({first_name, last_name, phone, email, vehicle, vin, zipcode, notes}){
    try {
      const result = await upsertCustomerToSupabase({
        first_name,
        last_name,
        phone,
        email,
        vehicle,
        vin,
        zipcode: zipcode || '',
        notes: notes || ''
      });
      return result;
    } catch (err) {
      console.error('‚ùå Error saving customer to Supabase:', err);
      return null;
    }
  }

  // Make a stable signature of the fields to control the pill state
  function sigFromNew(){
    const first = $('#naFirst')?.value||'';
    const last  = $('#naLast')?.value||'';
    const email = $('#naEmail')?.value||'';
    const phone = $('#naPhone')?.value||'';
    const vehicle = $('#naVehicle')?.value||'';
    const vin   = ($('#naVin')?.value||'');
    return [first,last,normEmail(email),normPhone(phone),vehicle,vin].join('||');
  }
  function sigFromEdit(){
    const name  = $('#apptForm [name="customer"]')?.value||'';
    const phone = $('#apptForm [name="phone"]')?.value||'';
    const email = $('#apptForm [name="email"]')?.value||'';
    const vehicle = $('#apptForm [name="vehicle"]')?.value||'';
    const vin   = ($('#apptVin')?.value||'');
    return [name,normPhone(phone),email,vehicle,vin].join('||');
  }

  function setSaved(btn){
    if(!btn) return;
    btn.classList.add('saved');
    btn.disabled = true;
    btn.innerHTML = '<span class="dot"></span> Saved';
    btn.dataset.saved = '1';
  }
  function setUnsaved(btn){
    if(!btn) return;
    btn.classList.remove('saved');
    btn.disabled = false;
    btn.innerHTML = '<span class="dot"></span> Save Customer';
    btn.dataset.saved = '0';
  }

  // Save flows - now using Supabase
  async function saveFromNewModal(btn){
    const first = $('#naFirst')?.value||'';
    const last  = $('#naLast')?.value||'';
    const email = $('#naEmail')?.value||'';
    const phone = $('#naPhone')?.value||'';
    const vehicle = $('#naVehicle')?.value||'';
    const vin   = ($('#naVin')?.value||'').trim();

    // Don't save if nothing to identify by
    if(!normPhone(phone) && !normEmail(email) && !first.trim() && !last.trim()) {
      console.log('‚ö†Ô∏è No identifying info to save customer');
      return;
    }

    // Save to Supabase
    const result = await saveCustomerToSupabase({
      first_name: first,
      last_name: last,
      phone,
      email,
      vehicle,
      vin,
      notes: ''
    });

    if(result) {
      console.log('‚úÖ Customer saved to Supabase:', result);
      btn.dataset.sig = sigFromNew();
      setSaved(btn);
    } else {
      console.error('‚ùå Failed to save customer');
    }
  }

  async function saveFromEditModal(btn){
    const name  = $('#apptForm [name="customer"]')?.value||'';
    const {first,last} = parseFullName(name);
    const phone = $('#apptForm [name="phone"]')?.value||'';
    const email = $('#apptForm [name="email"]')?.value||''; // Now we have email in edit modal
    const vehicle = $('#apptForm [name="vehicle"]')?.value||'';
    const vin   = ($('#apptVin')?.value||'').trim();

    // Don't save if nothing to identify by
    if(!normPhone(phone) && !normEmail(email) && !first.trim() && !last.trim()) {
      console.log('‚ö†Ô∏è No identifying info to save customer');
      return;
    }

    // Save to Supabase
    const result = await saveCustomerToSupabase({
      first_name: first,
      last_name: last,
      phone,
      email,
      vehicle,
      vin,
      notes: ''
    });

    if(result) {
      console.log('‚úÖ Customer saved to Supabase:', result);
      btn.dataset.sig = sigFromEdit();
      setSaved(btn);
    } else {
      console.error('‚ùå Failed to save customer');
    }
  }

  // Keep pill sticky until fields change
  function watchInputsFor(btn, inputs, sigFn){
    if(!btn) return;
    const handler = ()=>{
      const currentSig = sigFn();
      const savedSig = btn.dataset.sig || '';
      if(btn.dataset.saved==='1' && currentSig===savedSig){
        setSaved(btn); // ensure it stays locked
      } else {
        setUnsaved(btn); // allow re-save after user changes anything
      }
    };
    inputs.forEach(sel => $$(sel).forEach(el => el.addEventListener('input', handler)));
    // run once on load to set initial state
    handler();
  }

  const btnNew  = $('#saveCustNew');
  const btnEdit = $('#saveCustEdit');

  if(btnNew){
    btnNew.addEventListener('click', ()=> saveFromNewModal(btnNew));
    watchInputsFor(btnNew,
      ['#naFirst','#naLast','#naEmail','#naPhone','#naVehicle','#naVin'],
      sigFromNew
    );
  }
  if(btnEdit){
    btnEdit.addEventListener('click', ()=> saveFromEditModal(btnEdit));
    watchInputsFor(btnEdit,
      ['#apptForm [name="customer"]','#apptForm [name="phone"]','#apptForm [name="vehicle"]','#apptVin'],
      sigFromEdit
    );
  }

  // Hide for Staff
  if(isStaff()){ if(btnNew) btnNew.style.display='none'; if(btnEdit) btnEdit.style.display='none'; }

  // Check for #new hash to open modal
  if (window.location.hash === '#new') {
    $('#newApptModal').classList.remove('hidden');
    setTimeout(()=> $('#naFirst').focus(), 50);
  }
})();
</script>


<div id="viewApptModal" class="modal-backdrop hidden" onclick="closeViewApptModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h3>Appointment Details</h3>
      <button onclick="closeViewApptModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body" id="viewApptContent">
      <!-- content will be populated -->
    </div>
    <div class="modal-foot">
      <button onclick="closeViewApptModal()" class="btn">Close</button>
  <button id="editFromViewBtn" class="btn info">Edit Appointment</button>
    </div>
  </div>
</div>
<div id="statusModal" class="modal-backdrop hidden" onclick="closeStatusModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width: 400px;">
    <div class="modal-head">
      <h3>Select Status</h3>
      <button onclick="closeStatusModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="statusPills" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Pills will be populated -->
      </div>
    </div>
  </div>
</div>
</body>
</html>
